////////////////////////////////////////////////////////////////////////////////
// Quick Datalogger +RTP v2.5
// Auth: John Cui
//
// Desc: Used to add datalogging and RTP capabilities to the ECU
//       v1.5.1 Includes O2 sensor smoothing functions used for WB-O2s
//       v1.8 Includes 'Fix Lambda' plugin
//       v1.9 Includes corrected ignition address
//       v2.0 Completely new Protocol for Crome version 1.4 and up
//

function __addQuickDLRTP2P30 () {
  // /*
  // Add Datalogger + RTP
  //
  rom.byteAt(0x2565) = 0xF8;
  rom.byteAt(0x38D5) = 0xF8;
  rom.wordAt(0x000A) = 0x01FD;
  _rom_write(0x01FD,
             new Array(0xE5,0xF4,0xD5,0x1A,0xB5,0x04,0x98,0x02,
                       0x01,0x57,0x6F,0x00,0xF9,0xF5,0x55,0x23,
                       0xC0,0x00,0xCE,0x47,0xC6,0x07,0xC9,0x33,
                       0xC6,0x08,0xC9,0x34,0xC6,0xAB,0xC9,0x33,
                       0x8A,0xC6,0x28,0xC8,0x32,0xA6,0x10,0xCD,
                       0x03,0xAB,0xCB,0x17,0xE5,0x06,0x95,0x53,
                       0x62,0x96,0x02,0x92,0x81,0x92,0xA8,0x52,
                       0xB2,0x4A,0xF2,0x92,0x15,0x44,0x15,0x45,
                       0x15,0xD5,0x51,0xE5,0xF2,0xA2,0xD0,0xFE,
                       0xD5,0x1A,0x02,0x92,0xAA,0x72,0xCB,0xF1,
                       0x7D,0xCB,0xE8,0x77,0xCD,0xCB,0xE4,0x77,
                       0x55,0xCB,0xE0,0x23,0xC0,0x01,0xCE,0x04,
                       0x89,0xAB,0xCB,0xDF,0x23,0xC0,0x02,0xCE,
                       0x10,0x88,0x44,0x7A,0x22,0xC0,0x01,0xC9,
                       0x1A,0x22,0xC0,0x03,0xC9,0x1F,0xAB,0xCB,
                       0xCA,0x23,0xC0,0x03,0xCE,0xD9,0x22,0xC0,
                       0x02,0xC9,0x07,0x22,0xC0,0x04,0xC9,0x06,
                       0xCB,0xCD,0xD2,0xF2,0xCB,0xAD,0x92,0x80,
                       0x00,0x80,0xD2,0x44,0x7A,0x92,0xAA,0xCB,
                       0xA2,0xAC,0x00,0xAD,0x00,0xD8,0x01,0xD9,
                       0x01,0xA3,0x00,0xB9,0x00,0xD2,0x01,0xC6,
                       0x01,0xC7,0x01,0x5C,0x03,0x43,0x02,0xC0,
                       0x03,0xB4,0x00,0xC8,0x03,0xC1,0x03,0xC3,
                       0x00,0xC2,0x00,0x20,0x00,0x22,0x00,0x10,
                       0x02,0x11,0x02,0x12,0x01,0x13,0x01,0x14,
                       0x01,0x15,0x01),
             0xCB);
  _rom_fill(0x02C8, 0x02D4, 0xFF);
  /*
  // Add O2 Smoothing Function used for WB-O2 operations
  //
  rom.byteAt(0x0B10) = 0x03;
  rom.wordAt(0x0B11) = 0x02D5;
  _rom_write(0x02D5,
             new Array(0x32,0x48,0x52,0xD5,0xC2,0x03,0x13,0x0B),
             0x08);
  // */
}

function __addQuickDLRTP2P72 () {
  // /*
  // Add Datalogger + RTP
  //
  rom.byteAt(0x270C) = 0xF8;
  rom.byteAt(0x37C3) = 0xF8;
  
  rom.wordAt(0x000A) = 0x0218;
  _rom_write(0x0218,
             new Array(0xE5,0xFA,0xD5,0x1A,0xB5,0x04,0x98,0x02,
                       0x01,0x57,0x7E,0x00,0xF9,0xF5,0x55,0x23,
                       0xC0,0x00,0xCE,0x47,0xC6,0x07,0xC9,0x33,
                       0xC6,0x08,0xC9,0x34,0xC6,0xAB,0xC9,0x33,
                       0x8A,0xC6,0x28,0xC8,0x32,0xA6,0x10,0xCD,
                       0x03,0xAB,0xCB,0x17,0xE5,0x06,0x95,0x53,
                       0x62,0xB2,0x02,0x92,0x81,0x92,0xA8,0x52,
                       0xB2,0x4A,0xF2,0x92,0x15,0x44,0x15,0x45,
                       0x15,0xD5,0x51,0xE5,0xF8,0xA2,0xD0,0xFE,
                       0xD5,0x1A,0x02,0x92,0xAA,0x72,0xCB,0xF1,
                       0x7D,0xCB,0xE8,0x77,0xCD,0xCB,0xE4,0x77,
                       0x55,0xCB,0xE0,0x23,0xC0,0x01,0xCE,0x04,
                       0x89,0xAB,0xCB,0xDF,0x23,0xC0,0x02,0xCE,
                       0x10,0x88,0x44,0x7A,0x22,0xC0,0x01,0xC9,
                       0x1A,0x22,0xC0,0x03,0xC9,0x1F,0xAB,0xCB,
                       0xCA,0x23,0xC0,0x03,0xCE,0xD9,0x22,0xC0,
                       0x02,0xC9,0x07,0x22,0xC0,0x04,0xC9,0x06,
                       0xCB,0xCD,0xD2,0xF2,0xCB,0xAD,0x92,0x80,
                       0x00,0x80,0xD2,0x44,0x7A,0x92,0xAA,0xCB,
                       0xA2,0x00,0xC4,0x00,0xC5,0x00,0xE7,0x01,
                       0xE8,0x01,0xBB,0x00,0xA4,0x03,0xDF,0x01,
                       0xA6,0x03,0xA7,0x03,0x5B,0x03,0x44,0x02,
                       0xD8,0x00,0xCC,0x00,0xD9,0x00,0xBC,0x00,
                       0xDB,0x00,0xDA,0x00,0x20,0x00,0x22,0x00,
                       0x10,0x02,0x11,0x02,0x1A,0x01,0x1B,0x01,
                       0x1C,0x01,0x1D,0x01),
             0xCC);
  _rom_fill(0x02E4, 0x02EF, 0xFF);
  // */
  /*
  // Add O2 Smoothing Function used for WB-O2 operations
  //
  rom.byteAt(0x0B5A) = 0x03;
  rom.wordAt(0x0B5B) = 0x02F0;
  _rom_write(0x02F0,
             new Array(0x32,0x5B,0x50,0xD5,0xDA,0x03,0x5D,0x0B),
             0x08);
  // */
}

function __addQuickDLRTP () {
  // Start Group Undo Point
  rom.gup();
  switch (rom.base) {
    case rtP30:
      __addQuickDLRTP2P30();
      __fixLambdaP30();
      break;
    case rtP72:
      __addQuickDLRTP2P72();
      __fixLambdaP72();
      break;
    default:
      alert('Sorry, this ROM is not supported by this plugin.');
      return;
  }
  // */
  // End Group Undo Point
  rom.gup();
  reload();
  alert('Quick Datalogger +RTP Added!');
}

function __aboutQDLRTP() {
  alert("Quick Datalogger +RTP version 2.0\nby John Cui");
}

function __updateQDLRTP() {
  switch (rom.base) {
    case rtP30:
      if ((rom.wordAt(0x0209) == 0xF5F9) && (rom.wordAt(0x02C6) != 0x0115)) {
        rom.gup();
        __addQuickDLRTP2P30();
        __fixLambdaP30();
        rom.gup();
        alert('Critical updates have been made to this ROM. Please update your ECU to reflect these changes.');         
      }
      break;
    case rtP72:
      if ((rom.wordAt(0x0244) == 0xF5F9) && (rom.wordAt(0x02E4) != 0x011D)) {
        rom.gup();
        __addQuickDLRTP2P72();
        __fixLambdaP72();
        rom.gup();
        alert('Critical updates have been made to this ROM. Please update your ECU to reflect these changes.');        
      }
      break;
  }
}

/*******************************************************************************
** Fix Lambda
** auth: John Cui
** desc: This plugin fixes the issue of the "lambda tables" affecting the fuel
**       tales.  This simply replaces the lookup output of the lambda tables to
**       080h in essence detaching the tables from the code and converting them
**       into real lambda tables.
**/


function __fixLambdaP30() {
    _rom_write(0x169d, new Array (0x9C, 0x80, 0x00), 0x03);
}

function __fixLambdaP72() {
    _rom_write(0x1703, new Array (0x9C, 0x80, 0x00), 0x03);
}

addPlugin('John Cui', 'Quick Datalogger +RTP', '__addQuickDLRTP(1)', '__aboutQDLRTP()', 1);
addRomHandler(rtP30, 'John Cui', '__updateQDLRTP()');
addRomHandler(rtP72, 'John Cui', '__updateQDLRTP()');

